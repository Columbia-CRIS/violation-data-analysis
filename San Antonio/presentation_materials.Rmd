---
title: "Presentation Materials"
author: "Yu"
date: "3/13/2017"
output: 
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(dplyr)
knitr::opts_knit$set(root.dir = "~/Git/violation-data-analysis")
```

## Fatal Accidents

### Top 10 Fatal Quarters

```{r top 10 fatality, echo=FALSE}
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
top.deaths <- complete.active.quarters %>% filter(active) %>% arrange(desc(num.death)) %>% select(mine.name, mine_id, year, quarter, num.death)
head(top.deaths, 10)
```
### Top 10 Causes of Death
```{r top 10 causes of death, echo=FALSE}
if(!exists("accidents")){load("./San Antonio/data/secret_ingredients.RData")}
fatal.accidents <- accidents %>% 
  filter(inj_degr_desc == "FATALITY") %>%
  group_by(ai_class_desc) %>%
  summarise(count = n()
            ) %>%
  arrange(desc(count))
head(fatal.accidents, 10)
```

### Upper Big Branch and Other Deadliest Mine

#### [Upper Big Branch Mine (4608436)](https://en.wikipedia.org/wiki/Upper_Big_Branch_Mine_disaster)

```{r upper big branch, echo=FALSE}
# {r upper big branch, echo=FALSE, fig.show = 'hold', out.width = '49%'}
library(ggplot2)
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
# upper.big.branch <- complete.active.quarters %>% filter(mine_id == 4608436 & (year < 2010 | (year == 2010 & quarter < 2))) %>%
#   select(year, quarter, num.days.lost, viol.quantity)
# # ggplot() +
# #   geom_line(data = upper.big.branch, aes(x = year + quarter / 4, y = viol.quantity), color = "red") +
# #   geom_line(data = upper.big.branch, aes(x = year + quarter / 4, y = num.days.lost), color = "green")
# qplot(x=year + quarter / 4, y=viol.quantity, data=upper.big.branch, geom = "line",
#      main = "Upper Big Branch: Number of Quarterly Violations",
#      xlab = "Year", ylab = "Count")

yearly.viol <- complete.active.quarters %>% 
  filter(mine_id == 4608436 & year < 2010) %>%
  group_by(year) %>%
  summarise(count = sum(viol.quantity))
qplot(x = year, y = count, data = yearly.viol, geom = "line",
      main = "Number of Yearly Violations",
      xlab = "Year", ylab = "count")
```

#### [No. 5 Mine (101322)](http://www.chicagotribune.com/news/chi-0209220285sep22-story.html)

Usable violation data only date back to 2000.

#### [Sago Mine (4608791)](https://en.wikipedia.org/wiki/Sago_Mine_disaster)

```{r sago, echo=FALSE}
library(ggplot2)
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
yearly.viol <- complete.active.quarters %>% 
  filter(mine_id == 4608791 & year < 2006) %>%
  group_by(year) %>%
  summarise(count = sum(viol.quantity))
qplot(x = year, y = count, data = yearly.viol, geom = "line",
      main = "Number of Yearly Violations",
      xlab = "Year", ylab = "count")
```

#### [Crandall Canyon Mine (4201715)](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=2&cad=rja&uact=8&ved=0ahUKEwjOyeGnvtTSAhVN42MKHdtyD7UQFggnMAE&url=http%3A%2F%2Fwww.deseretnews.com%2Farticle%2F695206530%2FVictims-of-Crandall-Canyon-Mine-disaster.html&usg=AFQjCNHqcZNs-qEa9SipaDkfKfYy5okkGQ&sig2=WMuhLw2C0D1jAxkiBM1uiw)

```{r crandall, echo=FALSE}
library(ggplot2)
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}

yearly.viol <- complete.active.quarters %>% 
  filter(mine_id == 4201715 & year < 2007) %>%
  group_by(year) %>%
  summarise(count = sum(viol.quantity))
qplot(x = year, y = count, data = yearly.viol, geom = "line",
      main = "Number of Yearly Violations",
      xlab = "Year", ylab = "count")
```

#### [Darby Mine No. 1 (1518185)](http://www.chicagotribune.com/news/chi-0209220285sep22-story.html)

```{r darby, echo=FALSE}
library(ggplot2)
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
# darby.mine <- complete.active.quarters %>% filter(mine_id == 1518185 & (year < 2006 | (year == 2006 & quarter < 2))) %>%
#   select(year, quarter, num.days.lost, viol.quantity)
# qplot(x=year + quarter / 4, y=viol.quantity, data=darby.mine, geom = "line",
#      main = "Darby Mine No. 1: Number of Quarterly Violations",
#      xlab = "Year", ylab = "Count")

yearly.viol <- complete.active.quarters %>% 
  filter(mine_id == 1518185 & year < 2006) %>%
  group_by(year) %>%
  summarise(count = sum(viol.quantity))
qplot(x = year, y = count, data = yearly.viol, geom = "line",
      main = "Number of Yearly Violations",
      xlab = "Year", ylab = "count")
```

#### [Gibson Mine	(1202215)](http://coaldiver.org/msha-id/1202215)

```{r gibson, echo=FALSE}
library(ggplot2)
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
# gibson.mine <- complete.active.quarters %>% filter(mine_id == 1202215 & (year < 2007 | (year == 2007 & quarter < 3))) %>%
#   select(year, quarter, num.days.lost, viol.quantity)
# qplot(x=year + quarter / 4, y=viol.quantity, data=gibson.mine, geom = "line",
#      main = "Gibson Mine: Number of Quarterly Violations",
#      xlab = "Year", ylab = "Count")

yearly.viol <- complete.active.quarters %>% 
  filter(mine_id == 1202215 & year < 2007) %>%
  group_by(year) %>%
  summarise(count = sum(viol.quantity))
qplot(x = year, y = count, data = yearly.viol, geom = "line",
      main = "Number of Yearly Violations",
      xlab = "Year", ylab = "count")
```

#### Dotiki Mine

```{r Dotiki Mine, echo=FALSE}
library(ggplot2)
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
yearly.viol <- complete.active.quarters %>% 
  filter(mine_id == 1502132 & year < 2010) %>%
  group_by(year) %>%
  summarise(count = sum(viol.quantity))
qplot(x = year, y = count, data = yearly.viol, geom = "line",
      main = "Number of Yearly Violations",
      xlab = "Year", ylab = "count")
```

## Number of Days Lost not Implying Severity (e.g., New Era Mine)
[The American Coal Company New Era Mine (1102752)](http://www.stltoday.com/business/local/murray-energy-to-close-galatia-mine-next-year/article_aecf6963-c5ed-5edb-abd1-db6c5537a540.html)

Among the top 10 mine-quarters based on number of days lost,
```{r top 10 days lost, echo=FALSE}
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
top.days.lost <- complete.active.quarters %>% filter(active) %>% arrange(desc(num.days.lost)) %>% select(mine.name, year, quarter, num.days.lost)
head(top.days.lost, 10)
```
the "American Coal Company New Era Mine" take 5 spots.
Let's take a look at its second quarter of 2005:
```{r new era, echo=FALSE}
if(!exists("accidents")){load("./San Antonio/data/secret_ingredients.RData")}
new.era <- accidents %>% 
  filter(mine_id == 1102752 & cal_yr == 2005 & cal_qtr == 2) %>% 
  arrange(desc(days_lost)) %>% 
  select(
    ai_dt, 
    days_lost, 
    ai_class_desc
    #ai_occ_desc 
    #ai_narr
    ) 
head(new.era)
```
In particular, the top accident was:
```{r new era accident 1, echo=FALSE}
if(!exists("accidents")){load("./San Antonio/data/secret_ingredients.RData")}
new.era.top.accidents <- accidents %>% 
  filter(mine_id == 1102752 & cal_yr == 2005 & cal_qtr == 2) %>% 
  arrange(desc(days_lost)) %>% 
  select(
    ai_dt, 
    days_lost, 
    ai_class_desc,
    ai_occ_desc, 
    ai_narr
    ) 
print(as.character(new.era.top.accidents$ai_narr[1]))
```
and the second to top accident was:
```{r new era, accident 2, echo=FALSE}
if(!exists("new.era.top.accidents")){
 if(!exists("accidents")){load("./San Antonio/data/secret_ingredients.RData")}
new.era.top.accidents <- accidents %>% 
  filter(mine_id == 1102752 & cal_yr == 2005 & cal_qtr == 2) %>% 
  arrange(desc(days_lost)) %>% 
  select(
    ai_dt, 
    days_lost, 
    ai_class_desc,
    ai_occ_desc, 
    ai_narr
    )  
}
print(as.character(new.era.top.accidents$ai_narr[2]))
```

## Simple Linear Model

The following linear model tests a few predictors and their ability to predict number of days lost or restircted:
```{r simple lm of days lost/restricted, echo=FALSE}
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
num.days.lm <- lm(0*num.death+1*num.days.lost+1*num.days.restrict~last.quarter.lost+last.year.lost+last.three.years.lost
           +last.quarter.restrict+last.year.restrict+last.three.years.restrict
           +last.quarter.viol+last.year.viol+last.three.years.viol
           +last.quarter.death+last.year.death+last.three.years.death, 
           data=complete.active.quarters %>% filter(active))
summary(num.days.lm)
```
The following linear model tests a few predictors and their ability to predict number of deaths:
```{r simple lm of death, echo=FALSE}
if(!exists("complete.active.quarters")){load("./San Antonio/output/result.RData")}
num.deaths.lm <- lm(1*num.death+0*num.days.lost+0*num.days.restrict~last.quarter.lost+last.year.lost+last.three.years.lost
           +last.quarter.restrict+last.year.restrict+last.three.years.restrict
           +last.quarter.viol+last.year.viol+last.three.years.viol
           +last.quarter.death+last.year.death+last.three.years.death, 
           data=complete.active.quarters %>% filter(active))
summary(num.deaths.lm)
```